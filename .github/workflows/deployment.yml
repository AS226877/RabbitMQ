name: Build and Push Docker Images

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: externalacraction.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Set up Docker Buildx
      run: |
        docker buildx create --use
        docker buildx inspect --bootstrap

    - name: Create version tag
      run: |
        version=$(date +"%d.%m.%y-%H_%M_%S")
        echo "Version tag: $version"
        echo "::set-output name=version_tag::$version"

    - name: Build Docker images with version tag
      run: |
        docker-compose build --build-arg VERSION_TAG=${{ steps.create-version-tag.outputs.version_tag }}

    - name: Tag images with "latest" and push
      run: |
        version_tag=${{ steps.create-version-tag.outputs.version_tag }}

        # Tagging and pushing images with version tag
        docker-compose push

        # Tagging and pushing images with "latest" tag
        for service in $(docker-compose config --services); do
          docker tag externalacraction.azurecr.io/$service:$version_tag externalacraction.azurecr.io/$service:latest
          docker push externalacraction.azurecr.io/$service:latest
        done
